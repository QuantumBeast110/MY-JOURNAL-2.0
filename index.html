<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>My Journal</title>
    <style>
        /* ---------- Basic theme & layout ---------- */
        :root {
            --bg: linear-gradient(180deg, #f3f8ff, #eef6ff);
            --card: #ffffff;
            --muted: #64748b;
            --text: #0b1220;
            --accent: #4f46e5;
            --accent-2: #06b6d4;
            --radius: 14px;
        }

        [data-theme="dark"] {
            --bg: linear-gradient(180deg, #061426, #071426);
            --card: rgba(6, 14, 28, 0.9);
            --muted: #9aa3b2;
            --text: #e6eef8;
            --accent: #7ea0ff;
            --accent-2: #34d4e6;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased
        }

        .app {
            max-width: 540px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 14px
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px
        }

        .brand {
            display: flex;
            flex-direction: column
        }

        .title-main {
            font-size: 18px;
            margin: 0;
            color: var(--accent);
            font-weight: 700
        }

        .subtitle {
            font-size: 12px;
            margin: 0;
            color: var(--muted)
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: 0 10px 30px rgba(10, 20, 40, 0.06)
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .btn {
            background: var(--accent);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            border: 0;
            cursor: pointer;
            font-weight: 600
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(2, 6, 23, 0.06);
            padding: 8px;
            border-radius: 10px;
            cursor: pointer
        }

        .small {
            padding: 8px;
            font-size: 13px
        }

        .input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border-radius: 10px;
            border: 1px solid rgba(2, 6, 23, 0.06);
            background: transparent;
            font-size: 15px;
            outline: none
        }

        textarea {
            min-height: 120px;
            resize: vertical
        }

        .bottom-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 10px;
            display: flex;
            gap: 8px;
            max-width: 560px;
            margin: 0 auto;
            padding: 10px
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--muted);
            font-weight: 700;
            cursor: pointer
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.14)
        }

        .page {
            display: none;
            animation: fade .18s ease
        }

        .page.active {
            display: block
        }

        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        .entries {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .entry {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 10px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9))
        }

        .entry .meta {
            font-size: 13px;
            color: var(--muted)
        }

        .pill {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 999px;
            background: rgba(2, 6, 23, 0.04);
            font-size: 13px
        }

        .center {
            text-align: center
        }

        .canvas-wrap {
            padding: 8px;
            border-radius: 10px
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px
        }

        .cal-day {
            background: var(--card);
            padding: 8px;
            border-radius: 8px;
            min-height: 72px;
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .cal-date {
            font-size: 13px;
            color: var(--muted)
        }

        .dot {
            height: 9px;
            width: 9px;
            border-radius: 999px;
            display: inline-block;
            margin-right: 6px
        }

        .tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .welcome-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #ffb4e6, #a3c4ff, #baffc9);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px
        }

        .welcome-card {
            background: white;
            border-radius: 18px;
            padding: 18px;
            max-width: 460px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            text-align: center
        }

        @media(min-width:900px) {
            .app {
                margin-top: 30px;
                border-radius: 18px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.06)
            }

            .bottom-nav {
                position: static;
                margin-top: 8px
            }
        }
    </style>
</head>

<body data-theme="light">
    <div class="app" id="app">

        <!-- header -->
        <div class="header">
            <div class="brand">
                <div class="title-main" id="appTitle">My Journal</div>
                <div class="subtitle" id="appSubtitle">reflect â€¢ track â€¢ grow</div>
            </div>
            <div class="row">
                <button class="btn-ghost small" onclick="navigate('explore')">Explore</button>
                <button class="btn-ghost small" id="settingsBtn" onclick="navigate('settings')">Settings</button>
                <button class="btn small" id="themeBtn" onclick="cycleTheme()">Theme</button>
            </div>
        </div>

        <!-- PAGES -->
        <main>
            <!-- HOME -->
            <section id="home" class="page active">
                <div class="card center">
                    <h3 style="margin:6px 0">Welcome</h3>
                    <p class="muted">Tap Journal to record a moment. Use Advice or Weekly to learn and reflect.</p>
                    <div style="margin-top:12px" class="row">
                        <button class="btn" onclick="navigate('journal')">Journal</button>
                        <button class="btn-ghost small" onclick="navigate('advice')">Advice</button>
                    </div>
                </div>

                <div class="card" style="margin-top:10px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h4 style="margin:0">Recent entries</h4>
                        <div class="tools">
                            <input id="searchHome" class="input" placeholder="Search recent..." style="width:180px"
                                oninput="renderRecent()">
                            <button class="btn-ghost small" onclick="navigate('entries')">All</button>
                        </div>
                    </div>
                    <ul id="recentList" class="entries" style="margin-top:10px"></ul>
                </div>
            </section>

            <!-- JOURNAL -->
            <section id="journal" class="page">
                <div class="card">
                    <h3 style="margin:0;font-weight:700">Gratitude</h3>
                    <input id="gratitude" class="input" placeholder="I am thankful for..." />

                    <div style="margin-top:10px;font-weight:700;color:var(--text)">Mood</div>
                    <select id="moodSelect" class="input"></select>

                    <div style="margin-top:10px;font-weight:700;color:var(--text)">My expectation</div>
                    <textarea id="expectation" class="input" placeholder="Expecting..."></textarea>

                    <div style="margin-top:12px" class="row">
                        <button class="btn" onclick="saveJournal()">Save</button>
                        <button class="btn-ghost small" onclick="resetJournal()">Reset</button>
                    </div>
                </div>

                <div class="card" style="margin-top:10px">
                    <h4 style="margin:0">Entries</h4>
                    <div style="margin-top:8px" class="row">
                        <input id="search" class="input" placeholder="Search entries..." oninput="renderEntries()">
                        <select id="filterMood" class="input" onchange="renderEntries()">
                            <option value="all">All moods</option>
                        </select>
                    </div>
                    <ul id="entriesList" class="entries" style="margin-top:10px"></ul>
                </div>
            </section>

            <!-- ADVICE -->
            <section id="advice" class="page">
                <div class="card">
                    <h3 style="margin:0">Advice</h3>
                    <div style="margin-top:8px" class="row">
                        <select id="adviceMood" class="input"></select>
                        <button class="btn small" onclick="getAdvice()">Get Advice</button>
                    </div>
                    <div id="adviceBox"
                        style="margin-top:12px;min-height:90px;padding:8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9))">
                    </div>
                    <div style="margin-top:8px" class="muted">Advice is general supportive guidance. If you're
                        struggling, tell a trusted adult or seek help.</div>
                </div>
            </section>

            <!-- WEEKLY -->
            <section id="weekly" class="page">
                <div class="card">
                    <h3 style="margin:0">Weekly Analysis</h3>
                    <div class="canvas-wrap" style="margin-top:10px">
                        <canvas id="weeklyChart" width="600" height="220"></canvas>
                    </div>
                    <div id="weeklyText" class="muted" style="margin-top:8px"></div>
                </div>
            </section>

            <!-- CALENDAR -->
            <section id="calendar" class="page">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0">Calendar</h3>
                        <div class="row">
                            <button class="btn-ghost small" onclick="changeMonth(-1)">â—€</button>
                            <button class="btn-ghost small" onclick="changeMonth(1)">â–¶</button>
                        </div>
                    </div>
                    <div id="monthLabel" class="muted" style="margin-top:8px"></div>
                    <div id="calendarGrid" class="calendar-grid" style="margin-top:8px"></div>
                </div>
            </section>

            <!-- ENTRIES (full) -->
            <section id="entries" class="page">
                <div class="card">
                    <h3 style="margin:0">All entries</h3>
                    <div style="margin-top:8px" class="row">
                        <button class="btn small" onclick="exportJSON()">Export JSON</button>
                        <button class="btn-ghost small" onclick="window.print()">Export PDF</button>
                        <label class="btn-ghost small" style="display:inline-flex;align-items:center;gap:8px"><input
                                id="fileImport" type="file" accept=".json" style="display:none"
                                onchange="importJSON(event)" /><span
                                onclick="document.getElementById('fileImport').click()">Import</span></label>
                    </div>
                    <ul id="allEntriesList" class="entries" style="margin-top:10px"></ul>
                </div>
            </section>

            <!-- EXPLORE -->
            <section id="explore" class="page">
                <div class="card">
                    <h3 style="margin:0">Explore</h3>
                    <p class="muted" style="margin-top:8px">Short guides and tips to help you feel better and build
                        healthy habits.</p>
                    <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
                        <button class="btn-ghost small" onclick="openGuide('breathing')">Grounding & Breathing</button>
                        <button class="btn-ghost small" onclick="openGuide('sleep')">Sleep & Energy</button>
                        <button class="btn-ghost small" onclick="openGuide('focus')">Focus & Study Breaks</button>
                    </div>
                </div>
                <div id="guideBox" class="card" style="margin-top:10px;display:none"></div>
            </section>

            <!-- SETTINGS -->
            <section id="settings" class="page">
                <div class="card">
                    <h3 style="margin:0">Settings</h3>
                    <div style="margin-top:10px" class="row">
                        <button class="btn small" onclick="clearAll()">Clear all entries</button>
                        <button class="btn-ghost small" onclick="resetTheme()">Reset theme</button>
                    </div>
                    <div style="margin-top:10px" class="muted">Data stored locally in this browser/app. Export before
                        clearing to keep backups.</div>
                </div>
            </section>
        </main>

        <!-- bottom nav -->
        <div class="bottom-nav">
            <div class="nav-item active" data-target="home" onclick="navClick(this)">Home</div>
            <div class="nav-item" data-target="journal" onclick="navClick(this)">Journal</div>
            <div class="nav-item" data-target="advice" onclick="navClick(this)">Advice</div>
            <div class="nav-item" data-target="weekly" onclick="navClick(this)">Weekly</div>
            <div class="nav-item" data-target="calendar" onclick="navClick(this)">Calendar</div>
        </div>

    </div>

    <!-- Welcome screen (first-open / daily) -->
    <div id="welcome" class="welcome-screen" style="display:none">
        <div class="welcome-card">
            <h2 style="margin:0">Good to see you ðŸ‘‹</h2>
            <p class="muted" style="margin-top:8px">Daily reflection</p>
            <div style="margin-top:12px;text-align:left">
                <label style="font-weight:700">Gratitude</label>
                <input id="welcomeGratitude" class="input" placeholder="I am thankful for..." />
            </div>
            <div style="margin-top:12px" class="row">
                <button class="btn" onclick="saveWelcome()">Continue</button>
                <button class="btn-ghost small" onclick="dismissWelcome()">Skip</button>
            </div>
            <div class="muted" style="margin-top:10px;font-size:13px">This prompt shows once per day. You can edit it
                later in Journal.</div>
        </div>
    </div>

    <script>
        /* ------------- Storage keys and initialization ------------- */
        const LS_KEY = 'myjournal_entries_v1';
        let entries = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        let monthOffset = 0;

        /* Mood list (expanded) */
        const MOODS = ['very_happy', 'happy', 'content', 'blissful', 'excited', 'energetic', 'hopeful', 'optimistic', 'loving', 'calm', 'relaxed', 'peaceful', 'serene', 'grateful', 'satisfied', 'neutral', 'bored', 'meh', 'anxious', 'nervous', 'worried', 'stressed', 'overwhelmed', 'tense', 'restless', 'sad', 'down', 'melancholy', 'lonely', 'heartbroken', 'very_sad', 'depressed', 'hopeless', 'angry', 'irritated', 'frustrated', 'resentful', 'confused', 'uncertain', 'curious', 'guilty', 'ashamed', 'embarrassed', 'surprised', 'startled', 'amused', 'nostalgic', 'pensive', 'focused', 'productive', 'creative', 'motivated', 'afraid'];

        /* pretty labels */
        function moodLabel(k) {
            const map = {
                very_happy: 'Very Happy', happy: 'Happy', content: 'Content', blissful: 'Blissful', excited: 'Excited',
                energetic: 'Energetic', hopeful: 'Hopeful', optimistic: 'Optimistic', loving: 'Loving', calm: 'Calm',
                relaxed: 'Relaxed', peaceful: 'Peaceful', serene: 'Serene', grateful: 'Grateful', satisfied: 'Satisfied',
                neutral: 'Neutral', bored: 'Bored', meh: 'Meh', anxious: 'Anxious', nervous: 'Nervous', worried: 'Worried',
                stressed: 'Stressed', overwhelmed: 'Overwhelmed', tense: 'Tense', restless: 'Restless', sad: 'Sad', down: 'Down',
                melancholy: 'Melancholy', lonely: 'Lonely', heartbroken: 'Heartbroken', very_sad: 'Very Sad', depressed: 'Depressed',
                hopeless: 'Hopeless', angry: 'Angry', irritated: 'Irritated', frustrated: 'Frustrated', resentful: 'Resentful',
                confused: 'Confused', uncertain: 'Uncertain', curious: 'Curious', guilty: 'Guilty', ashamed: 'Ashamed',
                embarrassed: 'Embarrassed', surprised: 'Surprised', startled: 'Startled', amused: 'Amused', nostalgic: 'Nostalgic',
                pensive: 'Pensive', focused: 'Focused', productive: 'Productive', creative: 'Creative', motivated: 'Motivated',
                afraid: 'Afraid'
            };
            return map[k] || k;
        }

        /* ---------- Advice pools (sample sets) ---------- */
        const ADVICE_POOLS = {
            very_happy: ["Celebrate the moment.", "Write what made you smile.", "Share the joy with a friend.", "Capture it in a photo.", "Use the energy to create."],
            happy: ["Savor itâ€”notice details.", "Do something kind for others.", "Write a short thank-you note.", "Take a mindful break.", "Plan a small reward."],
            neutral: ["It's okayâ€”try a small walk.", "Drink water and stretch.", "Do a 5-minute task.", "Listen to soft music.", "Write one tiny plan."],
            sad: ["Be gentleâ€”rest or talk to someone.", "Write without judgment.", "Try a grounding exercise.", "Do a small comforting action.", "Limit heavy screens for a bit."],
            very_sad: ["Tell a trusted adult or friend how you feel.", "Sit with a safe person if possible.", "Small steps: water, breathe, step outside.", "Write a short note with kindness to yourself.", "Consider talking to someone who can help."],
            stressed: ["Take a 5-minute break and breathe.", "Break tasks into tiny steps.", "Try Pomodoro: 25/5.", "Step outside for fresh air.", "Stretch shoulders and neck."],
            angry: ["Pause and count to 10.", "Step away from the trigger.", "Write out what you feel and why.", "Take a quick walk to cool down.", "Use 'I' statements when you talk later."],
            generic: ["Take a breath and notice your body.", "Write one sentence about how you feel.", "Do one small kind thing for yourself.", "Call or message someone you trust.", "Try a grounding: name 5 things you see."]
        };

        /* ---------- UI initialization ---------- */
        function init() {
            // fill mood selects
            const ms = document.getElementById('moodSelect'), am = document.getElementById('adviceMood'), fm = document.getElementById('filterMood');
            MOODS.forEach(k => {
                const o = document.createElement('option'); o.value = k; o.textContent = moodLabel(k);
                ms.appendChild(o);
                am.appendChild(o.cloneNode(true));
                fm.appendChild(o.cloneNode(true));
            });
            // check if welcome should show (once per day)
            showWelcomeIfNeeded();
            renderEntries();
            renderRecent();
            renderCalendar();
            drawWeekly();
        }
        init();

        /* ---------- Welcome logic (shows once per day) ---------- */
        function showWelcomeIfNeeded() {
            const last = localStorage.getItem('mj_welcome_date');
            const today = (new Date()).toISOString().slice(0, 10);
            if (last !== today) {
                document.getElementById('welcome').style.display = 'flex';
            }
        }
        function saveWelcome() {
            const g = document.getElementById('welcomeGratitude').value.trim();
            if (g) {
                const dateISO = (new Date()).toISOString().slice(0, 10);
                entries.unshift({ id: Date.now(), gratitude: g, mood: 'grateful', expectation: '', date: dateISO });
                localStorage.setItem(LS_KEY, JSON.stringify(entries));
                renderEntries(); renderRecent(); renderCalendar(); drawWeekly();
            }
            localStorage.setItem('mj_welcome_date', (new Date()).toISOString().slice(0, 10));
            document.getElementById('welcome').style.display = 'none';
        }
        function dismissWelcome() {
            localStorage.setItem('mj_welcome_date', (new Date()).toISOString().slice(0, 10));
            document.getElementById('welcome').style.display = 'none';
        }

        /* ---------- Navigation helpers ---------- */
        function navClick(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            navigate(el.getAttribute('data-target'));
        }
        function navigate(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(pageId);
            if (el) el.classList.add('active');
            // page-specific updates
            if (pageId === 'weekly') drawWeekly();
            if (pageId === 'calendar') renderCalendar();
            if (pageId === 'entries') renderAll();
        }

        /* ---------- CRUD: Journal entries ---------- */
        function saveJournal() {
            const g = document.getElementById('gratitude').value.trim();
            const mood = document.getElementById('moodSelect').value;
            const exp = document.getElementById('expectation').value.trim();
            const dateISO = (new Date()).toISOString().slice(0, 10);
            if (!g && !exp) { alert('Please write something in Gratitude or Expectation to save.'); return; }
            entries.unshift({ id: Date.now(), gratitude: g, mood, expectation: exp, date: dateISO });
            localStorage.setItem(LS_KEY, JSON.stringify(entries));
            document.getElementById('gratitude').value = ''; document.getElementById('expectation').value = ''; document.getElementById('moodSelect').value = 'neutral';
            renderEntries(); renderRecent(); renderCalendar(); drawWeekly();
            alert('Saved to your journal.');
            navigate('home');
        }
        function resetJournal() { document.getElementById('gratitude').value = ''; document.getElementById('expectation').value = ''; document.getElementById('moodSelect').value = 'neutral'; }

        /* Render lists */
        function renderEntries() {
            const container = document.getElementById('entriesList');
            if (!container) return;
            const q = (document.getElementById('search')?.value || '').toLowerCase();
            const filter = document.getElementById('filterMood')?.value || 'all';
            container.innerHTML = '';
            let list = entries.slice();
            if (filter !== 'all') list = list.filter(e => e.mood === filter);
            if (q) list = list.filter(e => (e.gratitude || '').toLowerCase().includes(q) || (e.expectation || '').toLowerCase().includes(q) || e.date.includes(q));
            if (list.length === 0) { container.innerHTML = '<li class="muted">No entries</li>'; return; }
            list.forEach(e => {
                const li = document.createElement('li'); li.className = 'entry';
                li.innerHTML = `<div>
      <div class="meta"><span class="pill">${moodLabel(e.mood)}</span> <strong style="margin-left:8px">${e.gratitude || '(no gratitude)'}</strong></div>
      <div style="margin-top:6px">${e.expectation || ''}</div>
      <div class="muted" style="margin-top:8px">${pretty(e.date)}</div>
    </div>
    <div class="row">
      <button class="small btn-ghost" onclick="loadForEdit(${e.id})">Edit</button>
      <button class="small btn-ghost" onclick="deleteEntry(${e.id})">Delete</button>
      <button class="small btn-ghost" onclick="adviceFor(${e.id})">Advice</button>
    </div>`;
                container.appendChild(li);
            });
        }
        function renderAll() {
            const listEl = document.getElementById('allEntriesList'); listEl.innerHTML = '';
            if (entries.length === 0) { listEl.innerHTML = '<li class="muted">No entries</li>'; return; }
            entries.forEach(e => {
                const li = document.createElement('li'); li.className = 'entry';
                li.innerHTML = `<div>
      <div class="meta"><span class="pill">${moodLabel(e.mood)}</span> <strong style="margin-left:8px">${e.gratitude || ''}</strong></div>
      <div style="margin-top:6px">${e.expectation || ''}</div>
      <div class="muted" style="margin-top:8px">${pretty(e.date)}</div>
    </div>
    <div class="row">
      <button class="small btn-ghost" onclick="loadForEdit(${e.id})">Edit</button>
      <button class="small btn-ghost" onclick="deleteEntry(${e.id})">Delete</button>
    </div>`;
                listEl.appendChild(li);
            });
        }
        function renderRecent() {
            const c = document.getElementById('recentList'); if (!c) return;
            const q = (document.getElementById('searchHome')?.value || '').toLowerCase();
            c.innerHTML = '';
            const recent = entries.slice(0, 6).filter(e => !q || (e.gratitude || '').toLowerCase().includes(q) || (e.expectation || '').toLowerCase().includes(q));
            if (recent.length === 0) { c.innerHTML = '<li class="muted">No recent entries</li>'; return; }
            recent.forEach(e => {
                const li = document.createElement('li'); li.className = 'entry';
                li.innerHTML = `<div>
      <div class="meta">${pretty(e.date)} â€¢ <span class="pill">${moodLabel(e.mood)}</span></div>
      <div style="margin-top:6px">${e.gratitude || e.expectation || '(no note)'}</div>
    </div>
    <div class="row"><button class="small btn-ghost" onclick="loadForEdit(${e.id})">Open</button></div>`;
                c.appendChild(li);
            });
        }

        /* Edit / delete */
        function loadForEdit(id) {
            const e = entries.find(x => x.id === id); if (!e) return alert('Entry not found');
            // remove the original entry so save will act like update
            entries = entries.filter(x => x.id !== id);
            localStorage.setItem(LS_KEY, JSON.stringify(entries));
            document.getElementById('gratitude').value = e.gratitude || '';
            document.getElementById('expectation').value = e.expectation || '';
            document.getElementById('moodSelect').value = e.mood || 'neutral';
            navigate('journal');
        }
        function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            entries = entries.filter(x => x.id !== id);
            localStorage.setItem(LS_KEY, JSON.stringify(entries));
            renderEntries(); renderRecent(); renderCalendar(); drawWeekly();
        }

        /* ---------- Advice ---------- */
        function adviceFor(id) {
            const e = entries.find(x => x.id === id); if (!e) return;
            displayAdvice(e.mood);
            navigate('advice');
        }
        function getAdvice() {
            const m = document.getElementById('adviceMood').value;
            displayAdvice(m);
        }
        function displayAdvice(mood) {
            let pool = ADVICE_POOLS[mood] || ADVICE_POOLS['generic'];
            // randomize and choose up to 3 nonrepeat
            const picks = [];
            const used = new Set();
            while (picks.length < 3 && used.size < pool.length) {
                const r = Math.floor(Math.random() * pool.length);
                if (!used.has(r)) { used.add(r); picks.push(pool[r]); }
            }
            const box = document.getElementById('adviceBox'); box.innerHTML = picks.map(t => `<div style="margin-top:6px">â€¢ ${t}</div>`).join('');
        }

        /* ---------- Calendar ---------- */
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); if (!grid) return;
            grid.innerHTML = '';
            const now = new Date(); now.setMonth(now.getMonth() + monthOffset);
            const y = now.getFullYear(), m = now.getMonth();
            const first = new Date(y, m, 1); const start = first.getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            document.getElementById('monthLabel').textContent = first.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            for (let i = 0; i < start; i++) { const blank = document.createElement('div'); blank.className = 'cal-day'; blank.style.visibility = 'hidden'; grid.appendChild(blank); }
            for (let d = 1; d <= daysInMonth; d++) {
                const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEl = document.createElement('div'); dayEl.className = 'cal-day';
                dayEl.innerHTML = `<div class="cal-date">${d}</div>`;
                const dayEntries = entries.filter(e => e.date === iso);
                dayEntries.slice(0, 3).forEach(de => {
                    const dot = document.createElement('div'); dot.className = 'dot'; dot.style.background = colorForMood(de.mood); dayEl.appendChild(dot);
                });
                dayEl.onclick = () => {
                    const filtered = entries.filter(e => e.date === iso);
                    if (filtered.length) {
                        // show simple summary
                        alert(`${filtered.length} entry(ies) on ${iso}. Open Journal to view or edit.`);
                    } else {
                        alert(`No entries on ${iso}`);
                    }
                };
                grid.appendChild(dayEl);
            }
        }
        function changeMonth(dir) { monthOffset += dir; renderCalendar(); }

        /* ---------- Weekly graph ---------- */
        function drawWeekly() {
            const canvas = document.getElementById('weeklyChart'); if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const DPR = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * DPR; canvas.height = rect.height * DPR;
            ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.scale(DPR, DPR); ctx.clearRect(0, 0, rect.width, rect.height);

            // last 7 dates
            const days = [];
            for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(d.toISOString().slice(0, 10)); }
            const counts = days.map(dt => entries.filter(e => e.date === dt).length);
            const dayMood = days.map(dt => {
                const s = entries.filter(e => e.date === dt);
                const t = {}; s.forEach(x => t[x.mood] = (t[x.mood] || 0) + 1);
                const top = Object.keys(t).sort((a, b) => t[b] - t[a])[0];
                return top || 'neutral';
            });

            const padding = 28; const w = rect.width; const h = rect.height; const chartW = w - padding * 2; const chartH = h - padding * 2;
            const maxV = Math.max(1, ...counts);
            const barW = chartW / days.length * 0.6;

            // grid lines
            ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 1;
            for (let g = 0; g <= 3; g++) { const y = padding + (chartH * (g / 3)); ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + chartW, y); ctx.stroke(); }

            // bars & labels
            days.forEach((d, i) => {
                const x = padding + i * (chartW / days.length) + (chartW / days.length - barW) / 2;
                const hBar = (counts[i] / maxV) * (chartH - 10);
                const y = padding + chartH - hBar;
                ctx.fillStyle = colorForMood(dayMood[i]);
                roundRect(ctx, x, y, barW, hBar, 6, true);
                ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.font = '12px system-ui';
                ctx.fillText(String(counts[i]), x + barW / 2 - 6, y - 8);
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillText(d.slice(5), x, padding + chartH + 14);
            });

            // insight
            const totals = {}; entries.filter(e => days.includes(e.date)).forEach(e => totals[e.mood] = (totals[e.mood] || 0) + 1);
            const top = Object.keys(totals).sort((a, b) => totals[b] - totals[a])[0] || 'neutral';
            document.getElementById('weeklyText').innerHTML = `Top mood: <strong>${moodLabel(top)}</strong> â€¢ Entries: ${counts.reduce((a, b) => a + b, 0)}`;
        }
        function roundRect(ctx, x, y, w, h, r, fill, stroke) { if (typeof r === 'undefined') r = 6; ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke(); }

        /* ---------- Color helper ---------- */
        function colorForMood(m) {
            const palette = { very_happy: '#ffd166', happy: '#fecb8d', content: '#e6f4d9', blissful: '#fff1b6', excited: '#ffb3c1', calm: '#bfe6d0', grateful: '#ffdbe6', neutral: '#d1d5db', sad: '#cfeaff', very_sad: '#a0c4ff', stressed: '#ffd3b6', angry: '#ff9a9a' };
            return palette[m] || '#d1d5db';
        }

        /* ---------- Export / Import ---------- */
        function exportJSON() {
            const data = { entries, exportedAt: Date.now() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'my-journal-backup.json'; a.click(); URL.revokeObjectURL(url);
        }
        function importJSON(ev) {
            const f = ev.target.files[0]; if (!f) return;
            const r = new FileReader(); r.onload = e => {
                try {
                    const obj = JSON.parse(e.target.result);
                    if (obj.entries && Array.isArray(obj.entries)) {
                        const ids = new Set(entries.map(x => x.id));
                        const toAdd = obj.entries.filter(x => !ids.has(x.id));
                        entries = toAdd.concat(entries);
                        localStorage.setItem(LS_KEY, JSON.stringify(entries));
                        alert('Imported ' + toAdd.length + ' entries');
                        renderEntries(); renderRecent(); renderCalendar(); drawWeekly();
                    } else alert('Invalid file');
                } catch (err) { alert('Import failed'); }
            }; r.readAsText(f);
        }

        /* ---------- Helpers ---------- */
        function pretty(iso) { try { return new Date(iso).toLocaleDateString(); } catch (e) { return iso; } }

        /* ---------- Guides ---------- */
        function openGuide(k) {
            const box = document.getElementById('guideBox'); box.style.display = 'block';
            if (k === 'breathing') box.innerHTML = '<h4>Grounding & Breathing</h4><p class="muted">Try 4-4-4 breathing: inhale 4s, hold 4s, exhale 4s. Repeat 6 times.</p>';
            if (k === 'sleep') box.innerHTML = '<h4>Sleep & Energy</h4><p class="muted">Keep a routine: wind down 30 min before bed, limit screens, soft music helps.</p>';
            if (k === 'focus') box.innerHTML = '<h4>Focus</h4><p class="muted">Use Pomodoro: 25 min focus, 5 min break. Move in breaks to refresh.</p>';
        }

        /* ---------- Settings ---------- */
        function clearAll() { if (!confirm('Delete all entries?')) return; entries = []; localStorage.removeItem(LS_KEY); renderEntries(); renderRecent(); renderCalendar(); drawWeekly(); alert('All cleared'); }
        function applyTheme(name) {
            if (name === 'dark') { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('mj_theme', 'dark'); document.getElementById('themeBtn').textContent = 'Dark'; }
            else { document.body.removeAttribute('data-theme'); localStorage.setItem('mj_theme', 'light'); document.getElementById('themeBtn').textContent = 'Light'; }
        }
        function cycleTheme() { const cur = localStorage.getItem('mj_theme') || 'light'; applyTheme(cur === 'light' ? 'dark' : 'light'); }
        function resetTheme() { localStorage.removeItem('mj_theme'); applyTheme('light'); }

        /* ---------- Init & re-render on change ---------- */
        window.addEventListener('resize', () => { drawWeekly(); });
        (function boot() {
            const savedTheme = localStorage.getItem('mj_theme') || 'light'; if (savedTheme === 'dark') applyTheme('dark');
            document.getElementById('moodSelect') && renderEntries();
            renderEntries(); renderRecent(); renderCalendar(); drawWeekly();
            // set default date for entries if needed
        })();
    </script>
</body>

</html>